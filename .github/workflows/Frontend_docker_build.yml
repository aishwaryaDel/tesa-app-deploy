name: Backend Image Build and Push

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      image_name:
        required: true
        type: string
      image_tag:
        required: true
        type: string
      acr_name:
        required: true
        type: string
    secrets:
      azure_creds:
        required: true
      docker_env:
        required: true

jobs:
  build-image:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # âœ… Create .env file from JSON secret
      - name: Create .env file
        run: |
            set +x  # Disable command echoing
            {
            echo "DB_HOST=${{ fromJson(secrets.docker_env).DB_HOST }}"
            echo "DB_PORT=${{ fromJson(secrets.docker_env).DB_PORT }}"
            echo "DB_NAME=${{ fromJson(secrets.docker_env).DB_NAME }}"
            echo "DB_USER=${{ fromJson(secrets.docker_env).DB_USER }}"
            echo "DB_PASSWORD=${{ fromJson(secrets.docker_env).DB_PASSWORD }}"
            echo "DB_SSL=${{ fromJson(secrets.docker_env).DB_SSL }}"
            echo "JWT_SECRET=${{ fromJson(secrets.docker_env).JWT_SECRET }}"
            echo "JWT_EXPIRES_IN=${{ fromJson(secrets.docker_env).JWT_EXPIRES_IN }}"
            echo "PORT=${{ fromJson(secrets.docker_env).PORT }}"
            } >> backend/.env
        shell: bash
        
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.azure_creds }}

      - name: Build Docker image
        run: |
          docker build -t ${{ inputs.acr_name }}.azurecr.io/${{ inputs.image_name }}:${{ inputs.image_tag }} ./backend

      - name: Save image as artifact
        run: |
          docker save ${{ inputs.acr_name }}.azurecr.io/${{ inputs.image_name }}:${{ inputs.image_tag }} -o /tmp/docker-image.tar

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/docker-image.tar

  push-image:
    runs-on: ubuntu-latest
    needs: build-image
    steps:
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker image
        run: docker load -i /tmp/docker-image.tar

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.azure_creds }}

      - name: Log in to ACR
        run: az acr login --name ${{ inputs.acr_name }}

      - name: Push Docker image
        run: docker push ${{ inputs.acr_name }}.azurecr.io/${{ inputs.image_name }}:${{ inputs.image_tag }}